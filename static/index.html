<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waste management route optimization</title>
    <!-- Bulma-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <!-- Leaflet-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- FontAwesome icons-->
    <script src="https://kit.fontawesome.com/e499d74da8.js" crossorigin="anonymous"></script>
    <!-- Leaflet awesome markers-->
    <script
        src="https://cdn.jsdelivr.net/npm/leaflet.awesome-markers@2.0.5/dist/leaflet.awesome-markers.min.js"></script>
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/leaflet.awesome-markers@2.0.5/dist/leaflet.awesome-markers.min.css">
    <!-- Custom style -->
    <link rel="stylesheet" href="/static/style.css">
    <!-- JS script -->
    <script src="/static/map.js"></script>
    <script src="/static/ui.js"></script>
    <script src="/static/httpclient.js"></script>
</head>

<body>
    <!-- Vehicle settings modal -->
    <div id="vehicle-settings" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Vehicle settings</p>
                <button onclick="closeVehicleSettings()" class="delete" aria-label="close"></button>
            </header>
            <section class="modal-card-body">
                <!-- Modal content -->
                <div class="field">
                    <label class="label">Fuel</label>
                    <p class="control has-icons-left">
                        <input id="vehicle-fuel" class="input" type="text" placeholder="Fuel" readonly>
                        <span class="icon is-small is-left">
                            <i class="fas fa-gas-pump"></i>
                        </span>
                    </p>
                </div>
                <div class="field">
                    <label class="label">Brand</label>
                    <p class="control has-icons-left">
                        <input id="vehicle-brand" class="input" type="text" placeholder="Brand" readonly>
                        <span class="icon is-small is-left">
                            <i class="fas fa-signature"></i>
                        </span>
                    </p>
                </div>
                <div class="field">
                    <label class="label">Cargo volume</label>
                    <p class="control has-icons-left">
                        <input id="vehicle-cargo" class="input" type="number" placeholder="Cargo volume">
                        <span class="icon is-small is-left">
                            <i class="fas fa-box-open"></i>
                        </span>
                    </p>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button onclick="closeVehicleSettings()" class="button is-success">Save changes</button>
                <button onclick="closeVehicleSettings()" class="button">Cancel</button>
            </footer>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loading" class="columns is-mobile is-centered">
        <div class="column is-half has-text-centered">
            <button id="loading-animation" style="border: none;" class="button is-large is-loading">Loading</button>
            <p id="status-message">Loading data ...</p>
        </div>
    </div>
    <!-- Dashboard -->
    <div id="dashboard" class="columns is-mobile is-centered is-hidden">
        <!-- Leaflet map -->
        <div id="map" class="column is-three-quarters has-text-centered"></div>
        <div class="column">
            <h4 class="title is-4">Route optimization</h4>
            <h5 class="subtitle is-5">with Openroute</h5>
            <hr>
            <!-- Control panel -->
            <div class="field">
                <label class="label">District</label>
                <div class="control has-icons-left">
                    <div id="districts-select-div" class="select is-loading">
                        <select id="districts-select">
                            <option value="all">All</option>
                        </select>
                    </div>
                    <div class="icon is-small is-left">
                        <i class="fas fa-map"></i>
                    </div>
                </div>
            </div>
            <div class="field">
                <label class="label">Filling level (%)</label>
                <div class="control has-icons-left">
                    <input class="input" type="number" placeholder="50">
                    <span class="icon is-small is-left">
                        <i class="fas fa-dumpster"></i>
                    </span>
                </div>
            </div>
            <div class="field is-grouped">
                <p class="control">
                    <button class="button is-link">
                        Optimize
                    </button>
                </p>
                <p class="control">
                    <button class="button">
                        Reset
                    </button>
                </p>
            </div>
        </div>
    </div>

    <script>
        (async function main() {
            // Fetch data
            const wasteContainers = await get('wastecontainers');
            const trucks = await get('trucks');
            const districts = await get('districts')


            // On error, finish loading with error and terminate app
            const error = wasteContainers.error || trucks.error || districts.error
            if (error) {
                finishLoading(error)
                return;
            }
            finishLoading()

            // Fill select with districts
            fillDistrictsSelector("districts-select", districts)

            // Init Leaflet map
            map = createMap();

            // Print markers on map
            addMarkers(map, 'dumpster', 'blue', wasteContainers, false, true)
            addMarkers(map, 'truck', 'green', trucks, true, false, (vehicle) => {
                openVehicleSettings(vehicle)
            })

            // On district change
            document.getElementById("districts-select").addEventListener("change", (event) => {

                // Get target district
                const districtID = event.target.value

                if (districtID !== "all") {
                    // Find district polygon 
                    const target_district = districts.find(x => x.nombre === districtID)
                    const districtPolygon = target_district.geo_shape.geometry.coordinates[0]

                    // Reverse coords to fit leaflet coords system
                    districtPolygon.forEach(coords => {
                        coords = coords.reverse()
                    });

                    // Add leaflet polygon
                    let polygon = L.polygon(districtPolygon, { color: 'red' }).addTo(map)

                    // Pan to district center
                    map.panTo(target_district.geo_point_2d, {})

                    //filterWasteContainers(districtPolygon, 0.5, wasteContainers)
                }


            })


        }());

        function filterWasteContainers(targetArea, fillingLevel, wasteContainers) {
            // Get target district
            const target_district = districts.find(x => x.nombre === districtID)
            const districtPolygon = target_district.geo_shape.geometry.coordinates[0]



            // wasteContainers.forEach(container => {
            //     if (container.location) {
            //         const containerLocation = container.location.value.coordinates
            //         console.log(containerLocation, districtPolygon)
            //     }

            // });
        }
    </script>
</body>

</html>